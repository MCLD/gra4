@model GRA.Controllers.ViewModel.MissionControl.Participants.HouseholdListViewModel

@Html.Partial("_ParticipantPartial")

<div class="row" style="padding: 10px 0;">
    <div class="col-xs-12">
        @if (Model.Users.Count() == 0)
        {
            <div class="alert alert-warning">Participant is not a member of a household</div>
        }
        else
        {
            <form id="form" asp-controller="Participants" method="post" role="form">
                <input asp-for="Id" type="hidden" />
                @if (Model.CanLogActivity)
                {
                    <input asp-for="UserSelection" type="hidden" />
                    <input asp-for="MinutesRead" type="hidden" />
                    <input asp-for="SecretCode" type="hidden" />

                    <div class="row">
                        <div class="col-xs-12 col-sm-6 row-spacing">
                            <table>
                                <tr>
                                    <td style="padding-right:6px;">Apply</td>
                                    <td width="80px">
                                        <input data-action="@Url.Action("HouseholdApplyMinutesRead")" value="" class="form-control minutesInput" />
                                    </td>
                                    <td style="padding-left:6px;">
                                        <button type="submit" class="btn btn-primary minutesButton" data-action="@Url.Action("HouseholdApplyMinutesRead")">Minutes Read</button>
                                    </td>
                                </tr>
                                @if (!string.IsNullOrWhiteSpace(Model.MinutesReadMessage))
                                {
                                    <tr>
                                        <td>&nbsp;</td>
                                        <td colspan="2">@Model.MinutesReadMessage</td>
                                    </tr>
                                }
                            </table>

                        </div>
                        <div class="col-xs-12 col-sm-6 row-spacing">
                            <table>
                                <tr>
                                    <td style="padding-right:6px;">Apply</td>
                                    <td width="200px">
                                        <input data-action="@Url.Action("HouseholdApplySecretCode")" class="form-control codeInput" />
                                    </td>
                                    <td style="padding-left:6px;">
                                        <button type="submit" class="btn btn-primary codeButton" data-action="@Url.Action("HouseholdApplySecretCode")">Secret Code</button>
                                    </td>
                                </tr>
                                @if (!string.IsNullOrWhiteSpace(Model.SecretCodeMessage))
                                {
                                    <tr>
                                        <td>&nbsp;</td>
                                        <td colspan="2">@Html.Raw(Model.SecretCodeMessage)</td>
                                    </tr>
                                }
                            </table>
                        </div>
                    </div>
                }
                <div>
                    <table class="table table-condensed table-bordered link-table table-striped">
                        <thead>
                            <tr>
                                @if (Model.CanLogActivity)
                                {
                                    <th style="vertical-align:middle;" width="24px;"><input id="checkAll" type="checkbox" data-id="@Model.Head.Id" /></th>
                                }
                                @if (Model.CanReadMail)
                                {
                                    <th width="36px"><span class="fa fa-envelope fa-lg"></span></th>
                                }
                                <th>User</th>
                                <th>Points Earned</th>
                                <th>Book Code</th>
                                <th>Branch</th>
                                <th>Program</th>
                            </tr>
                            <tr class="warning @(Model.Id == Model.Head.Id ? "text-strong" : null)">
                                @if (Model.CanLogActivity)
                                {
                                    <td class="on-top" style="vertical-align:middle;">
                                        <input class="userSelection" data-id="@Model.Head.Id" type="checkbox" />
                                    </td>
                                }
                                @if (Model.CanReadMail)
                                {
                                    <td class="on-top" style="vertical-align:middle;">
                                        <a class="plain-link" asp-action="Mail" asp-route-id="@Model.Head.Id">
                                            @if (Model.Head.HasNewMail)
                                            {
                                                <span class="fa fa-envelope fa-lg"></span>
                                                <span class="fa fa-exclamation fa-2x exclamation-alert"></span>
                                            }
                                            else
                                            {
                                                <span class="fa fa-envelope fa-lg" style="color:grey;"></span>
                                            }
                                        </a>
                                    </td>

                                }
                                <td class="td-class">
                                    <a asp-action="Detail" asp-route-id="@Model.Head.Id" class="rowlink">
                                        <div>
                                            @if (Model.Head.Id == Model.Id)
                                            {
                                                <span class="fa fa-user"></span>
                                            }
                                            @Model.Head.FullName
                                        </div>
                                        <div>@Model.Head.Username</div>
                                    </a>
                                </td>
                                <td>@Model.Head.PointsEarned</td>
                                <td>@Model.Head.VendorCode</td>
                                <td>@Model.Head.BranchName</td>
                                <td>@Model.Head.ProgramName</td>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model.Users)
                            {
                                <tr class="@(Model.Id == user.Id ? "info text-strong" : null)">
                                    @if (Model.CanLogActivity)
                                    {
                                        <td class="on-top" style="vertical-align:middle;">
                                            <input class="userSelection" type="checkbox" data-id="@user.Id" />
                                        </td>
                                    }
                                    @if (Model.CanReadMail)
                                    {
                                        <td class="on-top" style="vertical-align:middle;">
                                            <a class="plain-link" asp-action="Mail" asp-route-id="@user.Id">
                                                @if (user.HasNewMail)
                                                {
                                                    <span class="fa fa-envelope fa-lg"></span>
                                                    <span class="fa fa-exclamation fa-2x exclamation-alert"></span>
                                                }
                                                else
                                                {
                                                    <span class="fa fa-envelope fa-lg" style="color:grey;"></span>
                                                }
                                            </a>
                                        </td>
                                    }
                                    <td class="td-class">
                                        <a asp-action="Detail" asp-route-id="@user.Id" class="rowlink">
                                            <div>
                                                @if (user.Id == Model.Id)
                                                {
                                                    <span class="fa fa-user"></span>
                                                }
                                                @user.FullName
                                            </div>
                                        </a>
                                        <div>
                                            @if (Model.CanEditDetails && string.IsNullOrWhiteSpace(user.Username))
                                            {
                                                <a class="btn btn-default btn-xs on-top"
                                                   asp-action="RegisterHouseholdMember"
                                                   asp-route-id="@user.Id">
                                                    <span class="fa fa-user-plus"></span>
                                                    Register Member
                                                </a>
                                            }
                                            else
                                            {
                                                @user.Username
                                            }
                                        </div>

                                    </td>
                                    <td>@user.PointsEarned</td>
                                    <td>@user.VendorCode</td>
                                    <td>@user.BranchName</td>
                                    <td>@user.ProgramName</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @if (Model.CanLogActivity)
                {
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 row-spacing">
                            <table>
                                <tr>
                                    <td style="padding-right:6px;">Apply</td>
                                    <td width="80px">
                                        <input data-action="@Url.Action("HouseholdApplyMinutesRead")" value="" class="form-control minutesInput" />
                                    </td>
                                    <td style="padding-left:6px;">
                                        <button type="submit" class="btn btn-primary minutesButton" data-action="@Url.Action("HouseholdApplyMinutesRead")">Minutes Read</button>
                                    </td>
                                </tr>
                                @if (!string.IsNullOrWhiteSpace(Model.MinutesReadMessage))
                                {
                                    <tr>
                                        <td>&nbsp;</td>
                                        <td colspan="2">@Model.MinutesReadMessage</td>
                                    </tr>
                                }
                            </table>

                        </div>
                        <div class="col-xs-12 col-sm-6 row-spacing">
                            <table>
                                <tr>
                                    <td style="padding-right:6px;">Apply</td>
                                    <td width="200px">
                                        <input data-action="@Url.Action("HouseholdApplySecretCode")" class="form-control codeInput" />
                                    </td>
                                    <td style="padding-left:6px;">
                                        <button type="submit" class="btn btn-primary codeButton" data-action="@Url.Action("HouseholdApplySecretCode")">Secret Code</button>
                                    </td>
                                </tr>
                                @if (!string.IsNullOrWhiteSpace(Model.SecretCodeMessage))
                                {
                                    <tr>
                                        <td>&nbsp;</td>
                                        <td colspan="2">@Html.Raw(Model.SecretCodeMessage)</td>
                                    </tr>
                                }
                            </table>
                        </div>
                    </div>
                }
            </form>
        }
    </div>
</div>

<div class="form-group">
    <a asp-action="Index" class="btn btn-default">Return to Participants</a>
    @if (Model.CanEditDetails)
    {
        <a asp-action="AddHouseholdMember" asp-route-id="@Model.Id" class="btn btn-default">Add Household Member</a>
    }
</div>

@section scripts
{
    <script>
        $(document).ready(function () {
            $('.td-class').each(function () {
                $(this).children('a.rowlink').height($(this).height() + 11);
            });
        });
        $(window).resize(function () {
            $('.td-class').each(function () {
                $(this).children('a.rowlink').height($(this).height() + 11);
            });
        });

        $("#checkAll").on("change", function (e) {
            if (e.originalEvent) {
                $(".userSelection").prop("checked", $(this).prop("checked"));
            }
        });

        $(".userSelection").on("change", function (e) {
            if (e.originalEvent) {
                if ($(".userSelection:not(:checked)").length) {
                    $("#checkAll").prop("checked", false);
                }
                else {
                    $("#checkAll").prop("checked", true);
                }
            }
        });

        $(".minutesInput").on("keyup keypress", function (e) {
            var keyCode = e.keyCode || e.which;
            if (keyCode === 13) {
                e.preventDefault();
                $("#MinutesRead").val($(this).val());
                SetUserSelection();
                $("#form").attr("action", $(this).data("action")).submit();
            }
        });

        $(".codeInput").on("keyup keypress", function (e) {
            var keyCode = e.keyCode || e.which;
            if (keyCode === 13) {
                e.preventDefault();
                $("#SecretCode").val($(this).val());
                SetUserSelection();
                $("#form").attr("action", $(this).data("action")).submit();
            }
        });

        $(".minutesButton").on("click", function (e) {
            e.preventDefault();
            $("#MinutesRead").val($(this).parent().parent().find(".minutesInput").val());
            SetUserSelection();
            $("#form").attr("action", $(this).data("action")).submit();
        });

        $(".codeButton").on("click", function (e) {
            e.preventDefault();
            $("#SecretCode").val($(this).parent().parent().find(".codeInput").val());
            SetUserSelection();
            $("#form").attr("action", $(this).data("action")).submit();
        });

        function SetUserSelection() {
            var selectionArray = [];
            $(".userSelection:checked").each(function () {
                selectionArray.push($(this).data("id"));
            });
            $("#UserSelection").val(selectionArray);
        };
    </script>
}